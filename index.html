<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Sign-In & Group Dashboard</title>
    <!-- Load Tailwind CSS for beautiful styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald green
                        'secondary': '#f97316', // Orange
                    },
                }
            }
        }
    </script>
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, onSnapshot, orderBy, limit, 
            serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global Firebase variables (provided by the Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Configuration for this specific application
        const MAX_STUDENTS_TO_DISPLAY = 30; 
        const DUMMY_TOTAL_SCORE = 100; // Since we are not running a real quiz, we simulate a score out of 100.

        // --- Initialization and Authentication ---
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Start Authentication Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // Hide loading, show content
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('opacity-0');
                        
                        // Load results only after auth is confirmed
                        loadGroupResults(); 
                    } else {
                        // User is signed out, attempt sign-in
                        handleAuth();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Error loading application. Check console for details.</p>`;
            }
        }

        async function handleAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously if no token is available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Authentication failed: ${error.message}</p>`;
            }
        }

        // --- Firestore Data Functions ---

        // The public collection path to store names and scores
        const SIGN_INS_COLLECTION = `artifacts/${appId}/public/data/student_signins`;

        /**
         * Saves the student's name and a dummy performance metric (e.g., 85/100)
         * to the Firestore database.
         * @param {string} studentName The name of the student.
         */
        async function saveStudentNameAndPerformance(studentName) {
            if (!isAuthReady || !db) return console.error("Database not ready.");

            const signinBtn = document.getElementById('signin-btn');
            signinBtn.disabled = true;
            signinBtn.innerHTML = 'Submitting...';

            try {
                // Generate a random score between 60 and 100 for demonstration
                const score = Math.floor(Math.random() * (100 - 60 + 1)) + 60; 

                await addDoc(collection(db, SIGN_INS_COLLECTION), {
                    studentName: studentName,
                    score: score,
                    total: DUMMY_TOTAL_SCORE,
                    timestamp: serverTimestamp(),
                    userId: userId 
                });
                
                showSuccessMessage(`Success! ${studentName}'s score (${score}%) recorded.`);
                document.getElementById('student-name-input').value = '';

            } catch (e) {
                console.error("Error adding document: ", e);
                showErrorMessage("Error saving name. Check console.");
            } finally {
                signinBtn.disabled = false;
                signinBtn.innerHTML = 'Sign In & Record Performance';
            }
        }

        /**
         * Sets up a real-time listener to fetch and update all group results.
         */
        function loadGroupResults() {
            if (!isAuthReady || !db) return;

            const resultsContainer = document.getElementById('group-results-list');
            const overallPerformance = document.getElementById('overall-performance-card');
            
            // Query: Get documents, ordered by timestamp (newest first), limited to the top 30
            const q = query(
                collection(db, SIGN_INS_COLLECTION), 
                orderBy("timestamp", "desc"),
                limit(MAX_STUDENTS_TO_DISPLAY)
            );

            // onSnapshot sets up the real-time listener!
            onSnapshot(q, (snapshot) => {
                const allResults = [];
                let totalScore = 0;
                let totalTests = 0;
                let totalMax = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allResults.push({ id: doc.id, ...data });
                    totalScore += data.score;
                    totalMax += data.total;
                    totalTests++;
                });

                // --- Calculate and Display Overall Performance ---
                const groupAverage = totalMax > 0 ? ((totalScore / totalMax) * 100).toFixed(1) : '0.0';
                
                // Update the large performance card
                overallPerformance.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xl font-semibold text-gray-600">Group Average Score</div>
                            <div class="text-6xl font-extrabold text-primary mt-2">${groupAverage}%</div>
                            <div class="text-sm text-gray-500 mt-1">Based on ${totalTests} Submissions</div>
                        </div>
                        <div class="text-primary opacity-50">
                            <!-- SVG Bar Chart Icon (Placeholder) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.5v17m0 0a3 3 0 01-6 0m6 0a3 3 0 016 0m-6 0h-3.5m6 0h3.5M3.5 10H7m0 0a3 3 0 000 6M7 10h10m0 0a3 3 0 010 6M10 7.5V16m-6 0h3.5m6 0h3.5m-6 0v-8.5" />
                            </svg>
                        </div>
                    </div>
                `;

                // --- Display Individual Results List ---
                resultsContainer.innerHTML = '';
                
                if (allResults.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center p-4 text-gray-500">No student data submitted yet. Be the first!</p>';
                    return;
                }

                allResults.forEach((result) => {
                    const accuracy = ((result.score / result.total) * 100).toFixed(0);
                    // Format timestamp
                    const timestamp = result.timestamp ? new Date(result.timestamp.seconds * 1000).toLocaleString('en-US', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : 'N/A';
                    
                    resultsContainer.innerHTML += `
                        <li class="flex justify-between items-center p-3 border-b border-gray-100 hover:bg-gray-50 transition">
                            <div class="font-medium text-gray-800 truncate">${result.studentName}</div>
                            <div class="text-right flex items-center space-x-4">
                                <span class="text-sm text-gray-500">${timestamp}</span>
                                <span class="font-bold text-lg ${accuracy >= 80 ? 'text-primary' : 'text-secondary'}">${accuracy}%</span>
                            </div>
                        </li>
                    `;
                });
            }, (error) => {
                console.error("Error listening to group results:", error);
                resultsContainer.innerHTML = `<p class="text-red-500 text-center p-4">Error loading results.</p>`;
            });
        }
        
        // --- UI Feedback Messages ---
        function showMessage(message, type = 'success') {
            const container = document.getElementById('feedback-message');
            container.textContent = message;
            container.className = `p-3 rounded-lg text-white font-semibold text-center mt-4 transition duration-300 ${type === 'success' ? 'bg-primary' : 'bg-red-500'}`;
            container.classList.remove('hidden');
            setTimeout(() => {
                container.classList.add('hidden');
            }, 3000);
        }

        function showSuccessMessage(message) { showMessage(message, 'success'); }
        function showErrorMessage(message) { showMessage(message, 'error'); }

        // --- Event Listener and Initial Load ---
        function handleSigninClick() {
            const name = document.getElementById('student-name-input').value.trim();
            if (name.length < 2) {
                showErrorMessage('Please enter a valid name (at least 2 characters).');
                return;
            }
            if (name.length > 30) {
                showErrorMessage('Name cannot exceed 30 characters.');
                return;
            }
            // Save the data to Firestore
            saveStudentNameAndPerformance(name);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const signinBtn = document.getElementById('signin-btn');
            signinBtn.addEventListener('click', handleSigninClick);

            const nameInput = document.getElementById('student-name-input');
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !signinBtn.disabled) {
                    handleSigninClick();
                }
            });
            
            // Start Firebase initialization
            initFirebase();
        });
    </script>
</head>
<body class="font-sans flex items-center justify-center min-h-screen p-4 sm:p-6 bg-gray-100">

    <!-- Loading State -->
    <div id="loading-state" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center p-8 z-10">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-primary mx-auto"></div>
        <p class="mt-4 text-gray-600">Connecting to secure database...</p>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-3xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl transition duration-500 opacity-0 space-y-8">
        
        <!-- Header -->
        <header class="text-center border-b pb-4">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900">
                Group Performance Tracker
            </h1>
            <p class="text-gray-600 text-lg">Real-time sign-in and performance dashboard.</p>
        </header>

        <!-- 1. Sign-In Form -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner space-y-4 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-700">Student Sign-In</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="student-name-input" placeholder="Enter Your Name (max 30 characters)" maxlength="30"
                       class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-secondary transition">
                <button id="signin-btn" class="bg-secondary text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Sign In & Record Performance
                </button>
            </div>
            <div id="feedback-message" class="hidden"></div>
        </div>

        <!-- 2. Group Performance Dashboard -->
        <div class="mt-8">
            <h3 class="text-2xl font-bold text-gray-700 mb-4">Overall Group Results</h3>
            
            <!-- Performance Card -->
            <div id="overall-performance-card" class="bg-white p-6 rounded-xl border-4 border-primary/50 shadow-lg min-h-[150px] flex items-center justify-center">
                <p class="text-gray-500">Awaiting data...</p>
            </div>

            <!-- Individual Results List (Limited to 30) -->
            <div class="mt-6">
                <h4 class="text-xl font-semibold text-gray-700 mb-3">Recent Student Entries (Max ${MAX_STUDENTS_TO_DISPLAY})</h4>
                <ul id="group-results-list" class="bg-white rounded-lg border border-gray-200 divide-y divide-gray-100 max-h-96 overflow-y-auto shadow-md">
                    <li class="p-4 text-center text-gray-500">Loading student entries...</li>
                    <!-- Student list will be injected here by the real-time listener -->
                </ul>
            </div>
            
            <p class="text-xs text-gray-400 mt-4 text-center">User Session ID: <span id="user-id-display">${userId || '...loading'}</span></p>

        </div>

    </div>
    
    <script>
        // Update the user ID display once known
        window.addEventListener('load', () => {
            const userIdDisplay = document.getElementById('user-id-display');
            if (window.userId) {
                userIdDisplay.textContent = window.userId;
            } else {
                // Wait for the onAuthStateChanged in the module script to set the ID
                setTimeout(() => {
                    if (document.querySelector('#app-container').classList.contains('opacity-0')) return;
                     userIdDisplay.textContent = (document.querySelector('body').outerHTML.match(/Current User ID: ([a-zA-Z0-9]+)/)?.[1] || 'Unknown').substring(0, 8) + '...';
                }, 2000); 
            }
        });
    </script>

</body>
</html>